# 登录功能优化 TODO

> 本文档记录了登录功能的优化点，按优先级排序，后续开发中逐步完善。

## 📋 优化清单

### 🔴 高优先级（必须实现）

#### 1. 缺少路由守卫（重要）
**问题描述：**
- 未登录用户可以直接访问受保护页面（如首页）
- 没有统一的权限控制机制

**解决方案：**
- [ ] 创建 `ProtectedRoute` 组件
- [ ] 实现登录状态检查
- [ ] 实现角色权限检查（可选）
- [ ] 未登录时跳转到登录页，并保存当前路径用于登录后回跳
- [ ] 更新路由配置，使用 `ProtectedRoute` 包裹需要登录的页面

**相关文件：**
- `client/src/components/auth/ProtectedRoute.tsx`（需创建）
- `client/src/router/index.tsx`（需更新）

---

#### 2. 登录页面未做已登录判断
**问题描述：**
- 已登录用户仍可以访问 `/login` 页面
- 造成不必要的页面跳转

**解决方案：**
- [ ] 在 `Login` 组件中添加 `useEffect` 检查登录状态
- [ ] 如果已登录，自动跳转到首页或之前访问的页面
- [ ] 使用 `useLocation` 获取登录前的路径

**相关文件：**
- `client/src/pages/Login.tsx`（需更新）

---

#### 3. Token 验证缺失
**问题描述：**
- 初始化时只检查 localStorage 是否有 token，没有验证 token 是否有效
- 如果 token 已过期，用户仍会看到已登录状态，直到发起请求才被发现

**解决方案：**
- [ ] 在 `AuthContext` 初始化时验证 token 有效性
- [ ] 方案1：调用后端验证接口（如果后端提供）
- [ ] 方案2：解析 JWT 检查过期时间
- [ ] 如果 token 无效，清除本地存储并跳转登录页

**相关文件：**
- `client/src/context/AuthContext.tsx`（需更新）
- `client/src/utils/auth.ts`（可能需要添加 JWT 解析工具）

---

### 🟡 中优先级（建议实现）

#### 4. 登录成功后跳转逻辑不完善
**问题描述：**
- 登录成功后固定跳转到 `/`
- 没有考虑：
  - 登录前访问的页面（redirect）
  - 不同角色的默认页面（管理员和业主可能不同）

**解决方案：**
- [ ] 在 `ProtectedRoute` 中保存登录前访问的路径
- [ ] 登录成功后优先跳转到保存的路径
- [ ] 如果没有保存路径，根据用户角色跳转到不同默认页面
- [ ] 管理员默认跳转到 `/admin/dashboard`
- [ ] 业主默认跳转到 `/resident/orders`

**相关文件：**
- `client/src/pages/Login.tsx`（需更新）
- `client/src/context/AuthContext.tsx`（可能需要更新）

---

#### 5. 登出后未清除跳转状态
**问题描述：**
- 在 `api.ts` 的响应拦截器中使用 `window.location.href` 硬跳转
- 丢失了 React Router 的状态管理

**解决方案：**
- [ ] 在响应拦截器中避免使用 `window.location.href`
- [ ] 方案1：通过事件通知 `AuthContext` 进行登出
- [ ] 方案2：使用 React Router 的 `navigate`（需要特殊处理）
- [ ] 在 `Layout` 组件的登出按钮中，使用 `navigate` 而不是硬跳转

**相关文件：**
- `client/src/utils/api.ts`（需更新）
- `client/src/components/layout/Layout.tsx`（需更新）

---

#### 6. 缺少 Token 过期时间检查
**问题描述：**
- 没有在客户端检查 token 是否即将过期
- 可能导致频繁触发自动刷新

**解决方案：**
- [ ] 解析 JWT 获取过期时间
- [ ] 在 token 即将过期前（如剩余 5 分钟）主动刷新
- [ ] 使用定时器或请求前检查
- [ ] 避免在每次请求时都检查，优化性能

**相关文件：**
- `client/src/utils/auth.ts`（需添加 JWT 解析工具）
- `client/src/context/AuthContext.tsx`（可能需要添加定时刷新逻辑）
- `client/src/utils/api.ts`（请求拦截器中添加检查）

---

### 🟢 低优先级（可选优化）

#### 7. 错误处理可以更细化
**问题描述：**
- 登录错误提示比较通用
- 可以根据不同的错误类型提供更友好的提示

**解决方案：**
- [ ] 根据后端返回的错误码或消息类型，提供不同的错误提示
- [ ] 例如：
  - "用户名或密码错误" → "用户名或密码不正确，请重试"
  - "用户不存在" → "该用户名不存在，请检查用户名"
  - "账户被锁定" → "账户已被锁定，请联系管理员"
- [ ] 添加错误码映射表

**相关文件：**
- `client/src/pages/Login.tsx`（需更新）
- `client/src/utils/errorMessages.ts`（可创建错误消息映射文件）

---

#### 8. 安全性问题
**问题描述：**
- 使用 localStorage 存储敏感信息（XSS 风险）
- 没有对输入做基础校验

**解决方案：**
- [ ] 输入校验：
  - [ ] 用户名长度限制（3-20 字符）
  - [ ] 密码长度限制（6-50 字符）
  - [ ] 特殊字符过滤（防止 SQL 注入、XSS）
- [ ] 安全性考虑：
  - [ ] 考虑使用 httpOnly cookie（需要后端配合）
  - [ ] 或继续使用 localStorage，但加强 XSS 防护
  - [ ] 添加 CSP（Content Security Policy）头
- [ ] 密码安全：
  - [ ] 前端不存储明文密码
  - [ ] 考虑添加密码强度提示

**相关文件：**
- `client/src/pages/Login.tsx`（需添加输入校验）
- `client/src/utils/validation.ts`（可创建校验工具文件）

---

## 📝 实施建议

1. **按优先级实施**：先完成高优先级任务，再处理中低优先级
2. **分阶段开发**：每个优化点可以单独提交，便于代码审查和回滚
3. **测试覆盖**：每个优化点完成后，进行充分测试
4. **文档更新**：完成优化后，更新相关文档

---

## 🔗 相关文档

- [API接口设计](./小区设备维修平台%20-%20API接口设计%20(V1.0).md)
- [功能规格清单](./小区设备维修平台%20-%20功能规格清单%20(V1.2).md)
- [开发计划](./小区设备维修平台%20-%20开发计划%20(V1.0).md)

---

**最后更新时间：** 2025-12-19  
**维护者：** 开发团队

